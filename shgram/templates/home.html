{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dropzone@5.5.1/dist/dropzone.min.css">
{% endblock %}


{% block body %}
<h1>AKAZA</h1>
{{ request.user }}
<button id="login">로그인</button>
<button id="logout">로그아웃</button>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/dropzone@5.5.1/dist/dropzone.min.js"></script>

<br>
<div id="formContainer">
    <form action="{% url 'content_create' %}" class="dropzone" id="uploader" style="background-color:whitesmoke;">
        <div class="dz-message" data-dz-message><span>드래그 드랍하거나 클릭하여 이미지 선택</span></div>
        <div class="fallback">
            <input name="file" type="file" />
        </div>
    </form>
    <div class="form-group">
        <label>아래에 글을 입력해주세요.</label>
        <textarea class="form-control rounded-0" id="text" rows="3"></textarea>
    </div>

    <div style="text-align: right;">
        <button type="button" class="btn btn-danger" id="upload">작성하기</button>
    </div>
</div>
{% for content in contents %}
{% for image in content.image_set.all %}
<div class="content">
    <div class="post">
        <div class="text-center user-block">
            <h5 class="text-info left-things">{{ content.user.username }}</h5>
            <img class="img-info img-circle img-bordered-sm" src="{{ image.image.url }}" alt="User Image">
            {% endfor %}
            <div>
                <span class="username left-things">
                    <a href="#" class="text-info">{{ content.user.username }}</a>
                    <a href="#" class="pull-right btn-box-tool"><i class="fa fa-times"></i></a>
                </span>
            </div>
            <p>{{ content.text }}</p>
        </div>
    </div>
</div>
{% endfor %}

</div>




<script>
    Dropzone.autoDiscover = false;

    var dropZoneUploader = new Dropzone('form#uploader', {
        init: function () {
            var dropzone = this;

            $('#upload').click(function () {
                dropZoneUploader.processQueue();
            });

            dropzone.on("sending", function (file, xhr, formData) {
                formData.append("text", $('#text').val());
            });
        },
        parallelUploads: 10,
        autoProcessQueue: false,
        type: 'POST',
        success: function () {
            location.reload();
        },
        error: function (e) {
            console.log(e)
            alert('에러가 발생했습니다. 다시 시도해주세요.');
        },
        acceptedFiles: ".jpeg,.jpg,.png,.gif",
        uploadMultiple: true,
    });

    $(document).ready(function () {
        /*
        
        var myDropZone = Dropzone.forElement(".dropzone");
        myDropZone.options.autoProcessQueue = false;
        myDropZone.on("sending", function(file, xhr, data) {
        
                    // First param is the variable name used server side
                    // Second param is the value, you can add what you what
                    // Here I added an input value
                    data.append("your_variable", $('#your_input').val());
                });
        */



        $(document).ready(function () {
            $('#login').click(function () {
                $.post('/apis/users/login', { 'username': $('#username').val(), 'password': $('#password').val() }, function () {
                    window.location = '/';
                }).fail(function (data) {
                    alert(data.responseJSON.message);
                });
            });
        });
</script>

<script>
        $(document).ready(function () {
            $('#logout').click(function () {
                $.get('/apis/users/logout', {}, function () {
                    window.location = '/';
                })
            });
        });
</script>
{% endblock %}